<!doctype html>
<html lang="en">
  <head>
    <!-- Use correct character set. -->
    <meta charset="utf-8" />
    <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <title>Cesium Sensor Volumes Example</title>
    <script type="application/javascript">
      var CESIUM_BASE_URL = '../node_modules/cesium/Build/Cesium/';
    </script>
    <link
      rel="stylesheet"
      href="../node_modules/cesium/Build/Cesium/Widgets/widgets.css"
    />
    <script type="importmap">
      {
        "imports": {
          "cesium": "../node_modules/cesium/Build/CesiumUnminified/index.js",
          "cesium-sensors": "../dist/cesium-sensors.esm.js"
        }
      }
    </script>
    <!-- <script src="../node_modules/cesium/Build/Cesium/Cesium.js" nomodule></script> -->
    <script
      src="../node_modules/cesium/Build/CesiumUnminified/index.js"
      type="module"
    ></script>
    <script type="module" src="../dist/cesium-sensors.esm.js"></script>

    <style>
      #cesiumContainer {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        margin: 0;
        overflow: hidden;
        padding: 0;
        font-family: sans-serif;
      }

      html {
        height: 100%;
      }

      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
        height: 100%;
      }

      #toolbar {
        margin: 5px;
        padding: 2px 5px;
        position: absolute;
      }
    </style>
  </head>
  <body>
    <div id="cesiumContainer"></div>
    <div id="toolbar"></div>
    <script type="module">
      import * as CesiumSensorVolumes from 'cesium-sensors';
      import * as Cesium from 'cesium';
      var viewer = new Cesium.Viewer('cesiumContainer', {
        contextOptions: {
          requestWebgl2: true,
        },
        sceneModePicker: false,
        //     imageryProvider: Cesium.createTileMapServiceImageryProvider({
        //             url: Cesium.buildModuleUrl('../node_modules/cesium/Build/Cesium/Assets/Textures/NaturalEarthII')
        //         }),
        baseLayerPicker: false,
        geocoder: false,
        shouldAnimate: true
      });

      var longitude = Cesium.Math.toRadians(-90.0);
      var latitude = Cesium.Math.toRadians(30.0);
      var altitude = 3000000.0;
      var clock = 0.0;
      var cone = Cesium.Math.toRadians(15.0);
      var twist = 0.0;

      function getModelMatrix() {
        var ellipsoid = viewer.scene.globe.ellipsoid;
        var location = ellipsoid.cartographicToCartesian(
          new Cesium.Cartographic(longitude, latitude, altitude)
        );
        var modelMatrix = Cesium.Transforms.northEastDownToFixedFrame(location);
        var orientation = Cesium.Matrix3.multiply(
          Cesium.Matrix3.multiply(
            Cesium.Matrix3.fromRotationZ(clock),
            Cesium.Matrix3.fromRotationY(cone),
            new Cesium.Matrix3()
          ),
          Cesium.Matrix3.fromRotationX(twist),
          new Cesium.Matrix3()
        );
        return Cesium.Matrix4.multiply(
          modelMatrix,
          Cesium.Matrix4.fromRotationTranslation(
            orientation,
            Cesium.Cartesian3.ZERO
          ),
          new Cesium.Matrix4()
        );
      }

      function addRectangularSensor() {
        viewer.scene.primitives.removeAll();
        const entities = new Cesium.EntityCollection();
        const sensor = entities.getOrCreateEntity('sensors');
        sensor.addProperty('rectangularSensor');

        // sensor.orientation = Cesium.Quaternion.fromHeadingPitchRoll(Cesium.HeadingPitchRoll.fromDegrees(0, 0, 90));
        // sensor.position = Cesium.Cartesian3.fromDegrees(-86, 34, 0);

        // sensor.rectangularSensor = new CesiumSensorVolumes.RectangularSensorGraphics();
        // sensor.rectangularSensor.xHalfAngle = Math.PI / 4;
        // sensor.rectangularSensor.yHalfAngle = Math.PI / 4;
        // sensor.rectangularSensor.radius = 1000000;
        // sensor.rectangularSensor.show = true;
        // sensor.rectangularSensor.showDomeSurfaces = true;
        // sensor.rectangularSensor.showLateralSurfaces = true;
        // sensor.rectangularSensor.showThroughEllipsoid = false;

        console.log(viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(-86, 34, 0),
          rectangularSensor: new CesiumSensorVolumes.RectangularSensorGraphics({
            radius: 1000000,
            xHalfAngle: Cesium.Math.toRadians(45),
            yHalfAngle: Cesium.Math.toRadians(45),
            lineColor: new Cesium.Color(0.0, 1.0, 1.0, 1.0),
            material: new Cesium.Color(0.0, 1.0, 1.0, 0.4),
            showScanPlane: true,
            scanPlaneColor: new Cesium.Color(0.0, 1.0, 1.0, 1.0),
            scanPlaneMode: 'vertical',
            scanPlaneRate: 3,
          }),
        }));
      }

      function addCustomSensor() {
        viewer.scene.primitives.removeAll();
        var customSensor = new CesiumSensorVolumes.CustomSensorVolume();

        var directions = [];
        for (var i = 0; i < 8; ++i) {
          var clock = Cesium.Math.toRadians(45.0 * i);
          var cone = Cesium.Math.toRadians(25.0);
          directions.push(new Cesium.Spherical(clock, cone));
        }

        customSensor.modelMatrix = getModelMatrix();
        customSensor.radius = 20000000.0;
        customSensor.directions = directions;
        viewer.scene.primitives.add(customSensor);
      }

      function addToolbarButton(text, onclick) {
        var button = document.createElement('button');
        button.type = 'button';
        button.className = 'cesium-button';
        button.onclick = onclick;
        button.textContent = text;
        document.getElementById('toolbar').appendChild(button);
      }

      addToolbarButton('Rectangular', addRectangularSensor);
      addToolbarButton('Custom', addCustomSensor);

      addRectangularSensor();
    </script>
  </body>
</html>
